<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>üß™ Pricing Fix Test</h1>
    
    <div class="test-container">
        <h2>Test 1: API Response</h2>
        <p>Test the pricing API directly to ensure it returns the correct format:</p>
        <button class="test-button" onclick="testAPI()">Test API Call</button>
        <div id="api-log" class="log"></div>
    </div>

    <div class="test-container">
        <h2>Test 2: Response Normalization</h2>
        <p>Test the response normalization function with different formats:</p>
        <button class="test-button" onclick="testNormalization()">Test Normalization</button>
        <div id="normalization-log" class="log"></div>
    </div>

    <div class="test-container">
        <h2>Test 3: Multiple Calls Prevention</h2>
        <p>Test that multiple rapid calls don't cause issues:</p>
        <button class="test-button" onclick="testMultipleCalls()">Test Multiple Calls</button>
        <div id="multiple-calls-log" class="log"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function testAPI() {
            const logElement = document.getElementById('api-log');
            logElement.innerHTML = '';
            
            log('api-log', 'Starting API test...', 'info');
            
            try {
                const payload = {
                    pickup: {
                        lat: 51.36971,
                        lng: 1.43346,
                        label: '3 Julie Close, Broadstairs'
                    },
                    dropoff: {
                        lat: 51.33514,
                        lng: 1.42618,
                        label: '4 Victoria Parade, Ramsgate'
                    },
                    vanType: 'medium',
                    crewSize: 2,
                    dateISO: '2025-08-29',
                    timeSlot: 'afternoon',
                    stairsFloors: 1
                };

                log('api-log', `Sending payload: ${JSON.stringify(payload, null, 2)}`, 'info');
                
                const response = await fetch('/api/pricing/quote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log('api-log', `Response received: ${JSON.stringify(data, null, 2)}`, 'success');
                
                // Validate response structure
                if (data.breakdown && typeof data.breakdown.totalPence === 'number') {
                    log('api-log', '‚úÖ Response structure is valid', 'success');
                } else {
                    log('api-log', '‚ùå Response structure is invalid', 'error');
                }
                
            } catch (error) {
                log('api-log', `‚ùå API test failed: ${error.message}`, 'error');
            }
        }

        function testNormalization() {
            const logElement = document.getElementById('normalization-log');
            logElement.innerHTML = '';
            
            log('normalization-log', 'Testing response normalization...', 'info');
            
            // Test different response formats
            const testCases = [
                {
                    name: 'Standard format',
                    data: {
                        breakdown: {
                            miles: 2.4,
                            basePence: 2500,
                            distancePence: 480,
                            surchargesPence: 1000,
                            totalPence: 3980
                        }
                    }
                },
                {
                    name: 'Quote wrapper format',
                    data: {
                        quote: {
                            totalGBP: 39.80,
                            breakdown: {
                                miles: 2.4,
                                totalPence: 3980
                            }
                        }
                    }
                },
                {
                    name: 'Simple format',
                    data: {
                        total: 39.80,
                        details: {
                            miles: 2.4
                        }
                    }
                }
            ];

            testCases.forEach(testCase => {
                try {
                    const normalized = normalizeQuoteShape(testCase.data);
                    log('normalization-log', `‚úÖ ${testCase.name}: ${JSON.stringify(normalized)}`, 'success');
                } catch (error) {
                    log('normalization-log', `‚ùå ${testCase.name}: ${error.message}`, 'error');
                }
            });
        }

        function normalizeQuoteShape(raw) {
            if (!raw) throw new Error('Empty response');

            const src = raw.quote ?? raw;

            const total =
                src.totalGBP ??
                src.total ??
                src.amount ??
                src.price ??
                src.data?.totalGBP ??
                src.data?.total ??
                (src.breakdown?.totalPence ? src.breakdown.totalPence / 100 : null);

            if (typeof total !== 'number') {
                throw new Error('Unexpected quote format from server');
            }

            return {
                totalGBP: total,
                breakdown: src.breakdown ?? src.details ?? src.data?.breakdown ?? {},
            };
        }

        async function testMultipleCalls() {
            const logElement = document.getElementById('multiple-calls-log');
            logElement.innerHTML = '';
            
            log('multiple-calls-log', 'Testing multiple rapid API calls...', 'info');
            
            const payload = {
                pickup: { lat: 51.36971, lng: 1.43346, label: 'Test Address 1' },
                dropoff: { lat: 51.33514, lng: 1.42618, label: 'Test Address 2' },
                vanType: 'medium',
                crewSize: 2,
                dateISO: '2025-08-29',
                timeSlot: 'afternoon',
                stairsFloors: 1
            };

            const promises = [];
            const startTime = Date.now();

            // Make 5 rapid calls
            for (let i = 0; i < 5; i++) {
                promises.push(
                    fetch('/api/pricing/quote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }).then(res => res.json())
                );
            }

            try {
                const results = await Promise.all(promises);
                const endTime = Date.now();
                
                log('multiple-calls-log', `‚úÖ All ${results.length} calls completed in ${endTime - startTime}ms`, 'success');
                
                results.forEach((result, index) => {
                    if (result.breakdown && result.breakdown.totalPence) {
                        log('multiple-calls-log', `‚úÖ Call ${index + 1}: ¬£${(result.breakdown.totalPence / 100).toFixed(2)}`, 'success');
                    } else {
                        log('multiple-calls-log', `‚ùå Call ${index + 1}: Invalid response`, 'error');
                    }
                });
                
            } catch (error) {
                log('multiple-calls-log', `‚ùå Multiple calls test failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
